---
title: Traffic Data Analysis
output: html_document
---

## Attaching the required libraries
```{r}
library(dplyr)
library(ggplot2)
library(corrplot)
```

## First acquaintance with the data
Loading the data:
```{r cache=TRUE}
df <- read.csv('all-semi-unique.csv')
```
Getting a glimpse of the data to know its dimensions, the data type for each column and an some of its assigned values:
```{r}
glimpse(df)
```
Getting the number of NAs for each column:
```{r}
sapply(df, function(x) sum(is.na(x)))
```

## Cleaning the data - Part I (Blind Cleaning)
Removing duplicate observations as well as columns that have a constant value in all observations:
```{r}
df <- unique(df)
df <- df[sapply(df, function(x) length(unique(x))) > 1]
glimpse(df)
```
There were no duplicate rows but we have successfully reduced the number of columns from 34 to 19. Before being able to process the data further, we need to make sure that we understand each column name.

## Cleaning the data - Part II (Educated Cleaning)

### `rd.rp.cmid` uniqueness
An initial guess for the meaning of this column is the report's comment ID. We take a look into the uniqueness of this ID for randonly selected IDs.
```{r}
df[df$rd.rp.cmid=="9424155",]
```
and:
```{r}
df[df$rd.rp.cmid=="9330190",]
```
We discover that each comment id was repeated more than once. The reason for this is attributed to different crawling times. Due to the crawling mechanism, it is possible that some data is duplicated if it still appears on bey2ollak.com feed in the next crawl. We note that the values for `rd.rp.hr` and `rd.rp.mn` change with respect to the crawl time. This change indicates that these two columns reperesent the elapsed time for this report (with respect to the crawl time of course).  
Such interpretation agrees with bey2ollak.com website since only elapsed times for roads and reports are provided, not the actual times.
This understanding provides two very useful applications:

#### Filter rows based on `rd.rp.cmid`
Now, the number of rows can be significantly reduced to represent each report only once   as follows:
```{r}
df <- df[!duplicated(df[,c("rd.rp.cmid")]),]
dim(df)
```
The number of rows is now significantly reduced to 148367.


#### Extract report and road absolute timings
Based on our previous understanding of `rd.rp.hr` and `rd.rp.min`, it is highly likely that `rd.hr` and `rd.mn` indicate the elapsed time of the latest report submitted for this report. What strengthens this theory is that this is the way bey2ollak.com website represents the time value written under each road.  
So, now we are going to properly represent the time values as time objects indicating the proper timestamp not relative times.
```{r}
df <- df %>% mutate(crawl_date=as.POSIXct(crawl_date, format = "%a %b %e %H:%M:%S UTC %Y", tz = "UTC"))
df <- df %>% mutate(rd.time = crawl_date - rd.mn * 60 - rd.hr*60*60, rd.rp.time = crawl_date - rd.rp.mn * 60 - rd.rp.hr*60*60)
```
We can now check if the `rd.time` is indeed the most recent `rd.rp.time`:
```{r}
#df %>% group_by(rd.ri,rd.crawl_date) %>% summarize(rdTime=mean(rd.time), maxRpTime=max(rd.rp.time))
#TODO
```

#Trivia

#### `rd.ri` meaning
By looking at the html source of bey2ollak.com we can confirm that the each value in `rd.ri` represents an id of the corresponding road. It is interesting to note that some anamolies were detected when running the following snippet.
```{r}
tmpDF <- df %>% group_by(rd.nm) %>% summarize(numRdId=length(unique(rd.ri)))
tmpDF[tmpDF$numRdId > 1,]
```
It was found that the three roads displayed in the above results have more than one id, which is weird. We found the reason to be that since bey2ollak.com supports roads in both Cairo and Alex, there are two roads named "Other Roads" in both cities. Also, there are multiple entries among the two cities for the Sa7rawy road connecting them.

#### `rd.new` meaning
`rd.new` is a boolean value that has a constant assignment 0 or 1 for each road. This is confirmed by the following snippet:
```{r}
tmpDF <- df %>% group_by(rd.nm) %>% summarize(numRdNew=length(unique(rd.new)))
nrow(tmpDF[tmpDF$numRdNew == 1,]) == nrow(tmpDF)
```
There is no clear intuition behind the column meaning and the html of bey2ollak.com provides no help in that regard.

#### `rd.strq` meaning

An interesting observation is the the `rd.strq` value is unset only for long travel roads, namely between Cairo & Alex, Cairo & Hurghada, Cairo & Sharm. On the other hand, the majority of the group of roads having this value set are roads inside a city, while a small proportion is shorter travel roads like Zera3y road between Cairo & Banha, Cairo & Tanta, Alex & Tanta. So, there are good reasons to believe that this value is thresholded by the distance. If interpreted as "status required", then we can theorize that bey2ollak.com does not require users to provide a status for comments on long travel roads. A look at the website html strengthens this hypothesis.
```{r}
strqUnset <- df[df$rd.strq==0,c("rd.strq","rd.nm")]
strqUnset <- strqUnset[!duplicated(strqUnset[,c("rd.nm")]),] %>% as.data.frame
strqUnset %>% head
strqSet <- df[df$rd.strq==1,c("rd.strq","rd.nm")]
strqSet <- strqSet[!duplicated(strqSet[,c("rd.nm")]),] %>% as.data.frame
strqSet %>% head
```

####Attempt at congested place
```{r}
tmpDf <- df[!is.na(df$rd.rp.stid),]
tmpDf <- tmpDf[tmpDf$rd.rp.stid < 6,]
#congestionDf <- tmpDf %>% group_by(rd.nm) %>% summarize(avRep=mean(rd.rp.stid)) %>% arrange(desc(avRep))
congestionDf <- tmpDf %>% group_by(rd.nm) %>% summarize(avRep=mean(rd.rp.stid), numRep=n()) %>% arrange(desc(avRep))
meanNmRep <- mean(congestionDf$numRep)
congestionDfHighNmRep <- congestionDf[congestionDf$numRep > meanNmRep,]
head(congestionDfHighNmRep)
```

####Attempt at congested hour
```{r}
tmpDf <- df[!is.na(df$rd.rp.stid),]
tmpDf <- tmpDf[tmpDf$rd.rp.stid < 6,]
tmpDf2 <- tmpDf %>% mutate(Hour=format(as.POSIXct(rd.rp.time, format="%a %b %e %H:%M:%S UTC %Y"), format="%H"))
tmpDf2 <- tmpDf2 %>% mutate(Hour = ((type.convert(Hour) + 2) %% 24))
congestionDf <- tmpDf2 %>% group_by(Hour) %>% summarize(avRep=mean(rd.rp.stid), numRep=n()) %>% arrange(desc(avRep))
congestionDf
```

####Attempt at highest user activity hour
```{r}
tmpDf <- df[!is.na(df$rd.rp.stid),]
tmpDf <- tmpDf[tmpDf$rd.rp.stid < 6,]
tmpDf2 <- tmpDf %>% mutate(Hour=format(as.POSIXct(rd.rp.time, format="%a %b %e %H:%M:%S UTC %Y"), format="%H"))
tmpDf2 <- tmpDf2 %>% mutate(Hour = ((type.convert(Hour) + 2) %% 24))
congestionDf <- tmpDf2 %>% group_by(Hour) %>% summarize(avRep=mean(rd.rp.stid), numRep=n()) %>% arrange(desc(numRep))
congestionDf
```

####Attempt at congested day
```{r}
tmpDf <- df[!is.na(df$rd.rp.stid),]
tmpDf <- tmpDf[tmpDf$rd.rp.stid < 6,]
tmpDf2 <- tmpDf %>% mutate(Weekday=format(as.POSIXct(rd.rp.time, format="%a %b %e %H:%M:%S UTC %Y"), format="%a"))
congestionDf <- tmpDf2 %>% group_by(Weekday) %>% summarize(avRep=mean(rd.rp.stid), numRep=n()) %>% arrange(desc(avRep))
congestionDf
```

#### Image columns


#### Testing correlations
```{r}
cor_feats = c("rd.ri","rd.stid","rd.hr","rd.mn","rd.new","rd.strq","rd.cmrq","rd.rp.hr","rd.rp.mn","rd.rp.stid","rd.rp.cmid","rd.rp.rpImg","rd.rp.img")
cor_mat = cor(df[, cor_feats], use = "complete")
corrplot(method = "shade", cor_mat)
cor_mat
```
Le3b association
```{r}

```

#### Conclusions

1.`crawl_date` describes the date in UTC at which the data was crawled from bey2ollak.com
2. It is clear that `rd.nm` means the name of the road
3. `rd.ri`
4. `rd.stid`
5. `rd.hr`
6. `rd.mn`
7. `rd.new` is a boolean value TODO
8. `rd.img`
9. `rd.strq` is a boolean value TODO
10. `rd.cmrq` is a boolean value TODO
11. `rd.rp.nm` means the username of the user who submitted the report
12. `rd.rp.fullnm` means the fullname of the user who submitted the report
13. `rd.rp.hr` is the the number of hours between the time the report was created and the crawl time
14. `rd.rp.mn` complements `rd.rp.hr` with the number of minutes
15. `rd.rp.stid`
16. `rd.rp.cm` means the comment of this report on the current state of the road
17.  `rd.rp.cmid` is the unique id of the report comment.
18. `rd.rp.rpImg`
19. `rd.rp.img` is the id of the logo image of the user who submitted the report
